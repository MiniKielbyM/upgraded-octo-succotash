import{__awaiter as t,__classPrivateFieldGet as e,__classPrivateFieldSet as i}from"tslib";import o from"@descope/web-js-sdk";const r="undefined"!=typeof localStorage,n=r&&localStorage.getItem("base.content.url")||"https://static.descope.com/pages",s="descope-login-flow",a="code",l="ra-challenge",d="ra-callback",c="ra-initiator",u="data-exclude-field",h="dls_last_auth",f="state_id",v="data-type",p="redirect",g="poll",m="webauthnCreate",b="webauthnGet",w="submit",y="polling";var I,k,C;function A(t){return new URLSearchParams(window.location.search).get(t)}function S(t){if(window.history.replaceState&&A(t)){const e=new URL(window.location.href),i=new URLSearchParams(e.search);i.delete(t),e.search=i.toString(),window.history.replaceState({},"",e.toString())}}function x(e,i){return t(this,void 0,void 0,(function*(){const t=yield fetch(e,{cache:"default"});if(!t.ok)throw Error(`Error fetching URL ${e} [${t.status}]`);return{body:yield t[i||"text"](),headers:Object.fromEntries(t.headers.entries())}}))}!function(t){t.backward="backward",t.forward="forward"}(I||(I={}));function E(t,e){const i=new URL(n);return i.pathname=((...t)=>t.join("/").replace(/\/+/g,"/"))(i.pathname,t,"v2-alpha",e),i.toString()}function j(t,e){if(!Number.isNaN(t)&&!Number.isNaN(e))return t>e?I.forward:t<e?I.backward:void 0}const O=()=>{const[t="",e=""]=(A(s)||"").split("_");return{executionId:t,stepId:e}};function W(){return/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}function L(){S(s)}const U=t=>t.replace(/-./g,(t=>t[1].toUpperCase())),$=()=>{const{executionId:t,stepId:e}=O();(t||e)&&L();const i=A("t")||void 0;i&&S("t");const o=A(a)||void 0;o&&S(a);const r=A("err")||void 0;r&&S("err");const{redirectAuthCodeChallenge:n,redirectAuthCallbackUrl:s,redirectAuthInitiator:u}={redirectAuthCodeChallenge:A(l),redirectAuthCallbackUrl:A(d),redirectAuthInitiator:A(c)};(n||s||u)&&(S(l),S(d),S(c));const h=A(f);return h&&S(f),{executionId:t,stepId:e,token:i,code:o,exchangeError:r,redirectAuthCodeChallenge:n,redirectAuthCallbackUrl:s,redirectAuthInitiator:u,oidcIdpStateId:h}},T=t=>{let e,i;return(...o)=>{return e&&(n=o,(r=e).length===n.length&&r.every(((t,e)=>t===n[e])))||(e=o,i=t(...o)),i;var r,n}},M=null===(C=null===(k=null===navigator||void 0===navigator?void 0:navigator.userAgentData)||void 0===k?void 0:k.brands)||void 0===C?void 0:C.find((({brand:t,version:e})=>"Chromium"===t&&parseFloat(e))),R=(t,e)=>t&&!e;var P,q,N,F;function K(t,e){const i=Object.getOwnPropertyNames(t),o=Object.getOwnPropertyNames(e);if(i.length!==o.length)return!1;for(let o=0;o<i.length;o+=1){const r=i[o],n=t[r],s=e[r];if(null===n||null===s){if(n!==s)return!1}else if("object"==typeof n&&"object"==typeof s){if(!K(n,s))return!1}else if(n!==s)return!1}return!0}class D{constructor(t={},{updateOnlyOnChange:o=!0}={}){P.set(this,void 0),q.set(this,{}),N.set(this,0),F.set(this,!1),this.update=t=>{const o="function"==typeof t?t(e(this,P,"f")):t,r=Object.assign(Object.assign({},e(this,P,"f")),o);if(!e(this,F,"f")||!K(e(this,P,"f"),r)){const t=e(this,P,"f");i(this,P,r,"f"),Object.freeze(e(this,P,"f")),setTimeout((()=>{Object.values(e(this,q,"f")).forEach((e=>e(r,t,((t,e)=>i=>t[i]!==e[i])(r,t))))}),0)}},i(this,P,t,"f"),i(this,F,o,"f")}get current(){return Object.assign({},e(this,P,"f"))}subscribe(t){return i(this,N,e(this,N,"f")+1,"f"),e(this,q,"f")[e(this,N,"f")]=t,e(this,N,"f").toString()}unsubscribe(t){const i=!!e(this,q,"f")[t];return i&&delete e(this,q,"f")[t],i}unsubscribeAll(){return i(this,q,{},"f"),!0}}P=new WeakMap,q=new WeakMap,N=new WeakMap,F=new WeakMap;const H=(t,e)=>{Object.entries(e||{}).forEach((([e,i])=>{Array.from(t.querySelectorAll(`.descope-input[name="${e}"]:not([${u}])`)).forEach((t=>{t.value=i}))}))},V=(t,e,i,o)=>{var r;let n=null==e?void 0:e.errorText;try{n=(null==i?void 0:i({text:null==e?void 0:e.errorText,type:null==e?void 0:e.errorType}))||(null==e?void 0:e.errorText)}catch(t){o.error("Error transforming error message",t.message)}((t,e,i="")=>{t.querySelectorAll(`[${v}="${e}"]`).forEach((t=>{t.textContent=i,t.classList[i?"remove":"add"]("hide")}))})(t,"error-message",n),H(t,null==e?void 0:e.inputs),H(t,null==e?void 0:e.form),((t,e)=>{t.querySelectorAll(`[${v}="totp-link"]`).forEach((t=>{t.href=e}))})(t,null===(r=null==e?void 0:e.totp)||void 0===r?void 0:r.provisionUrl),((t,e)=>{t.querySelectorAll(".descope-text,.descope-link").forEach((t=>{t.textContent=((t,e)=>t.replace(/{{(.+?)}}/g,((t,i)=>{return o=e,i.split(".").reduce(((t,e)=>(null==t?void 0:t[e])||""),o);var o})))(t.textContent,e)}))})(t,e)},B=T((()=>t(void 0,void 0,void 0,(function*(){var t,e,i,o;if(!window.PublicKeyCredential||!PublicKeyCredential.isConditionalMediationAvailable||!PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable)return console.warn("webauthn","Conditional UI is not supported"),!1;try{const r=Promise.all([null===(t=window.PublicKeyCredential)||void 0===t?void 0:t.isConditionalMediationAvailable(),null===(e=window.PublicKeyCredential)||void 0===e?void 0:e.isUserVerifyingPlatformAuthenticatorAvailable()]).then((t=>t.every((t=>!!t)))),n=108;return yield Promise.race([r,(i=100,new Promise(((t,e)=>{const r=setTimeout((()=>{e(new Error(`Promise timed out after ${i} ms`))}),i);null==o||o((e=>{clearTimeout(r),t(e)}),(t=>{clearTimeout(r),e(t)}))}))).catch((()=>M()>=n))])}catch(t){return console.warn("webauthn","Conditional login check failed",t),!1}})))),J={"lastAuth.loginId":{"not-empty":t=>!!t.loginId,empty:t=>!t.loginId},idpInitiated:{"is-true":t=>!!t.code,"is-false":t=>!t.code},externalToken:{"is-true":t=>!!t.token,"is-false":t=>!t.token}};function _(t){const e={};if(t)try{Object.assign(e,JSON.parse(localStorage.getItem(h)))}catch(t){}return e}const z=document.createElement("template");var G,Q,X,Y,Z,tt,et,it,ot,rt,nt,st,at,lt,dt,ct,ut,ht,ft,vt,pt,gt,mt,bt,wt,yt,It,kt,Ct,At,St,xt,Et,jt,Ot,Wt,Lt,Ut,$t;z.innerHTML='\n\t<style>\n\t\t:host {\n\t\t\twidth: 100%;\n\t\t\theight: 100%;\n\t\t}\n\t\t\n\t\t#wc-root {\n\t\t\theight: 100%;\n\t\t\ttransition: opacity 300ms ease-in-out;\n\t\t}\n\n\t\t#wc-root[data-theme] {\n\t\t\tbackground-color: transparent;\n\t\t}\n\n\t\t.fade-out {\n\t\t\topacity: 0.1;\n\t\t}\n\n\t</style>\n\t<div id="wc-root"></div>\n\t';class Tt extends HTMLElement{static get observedAttributes(){return["project-id","flow-id","base-url","tenant","theme","locale","debug","telemetryKey","redirect-url","auto-focus","prefer-biometrics"]}constructor(o){super(),G.add(this),this.logger=console,Q.set(this,!1),this.loggerWrapper={error:(t,i="")=>{this.logger.error(t,i,new Error),e(this,G,"m",mt).call(this,t,i)},warn:(t,e="")=>{this.logger.warn(t,e)},info:(t,e="",i={})=>{this.logger.info(t,e,i)}},X.set(this,new D({deferredRedirect:!1})),Y.set(this,new D),this.nextRequestStatus=new D({isLoading:!1}),Z.set(this,void 0),tt.set(this,{popstate:e(this,G,"m",st).bind(this),visibilitychange:e(this,G,"m",at).bind(this)}),et.set(this,void 0),ct.set(this,T((()=>t(this,void 0,void 0,(function*(){const t=E(this.projectId,"config.json");try{const{body:e,headers:i}=yield x(t,"json");return{projectConfig:e,executionContext:{geo:i["x-geo"]}}}catch(t){this.loggerWrapper.error("Cannot get config file","make sure that your projectId & flowId are correct")}return{}}))))),i(this,et,o,"f"),e(this,G,"m",it).call(this)}get projectId(){return this.getAttribute("project-id")}get flowId(){return this.getAttribute("flow-id")}get baseUrl(){return this.getAttribute("base-url")||void 0}get tenant(){return this.getAttribute("tenant")||void 0}get redirectUrl(){return this.getAttribute("redirect-url")||void 0}get debug(){return"true"===this.getAttribute("debug")}get locale(){return this.getAttribute("locale")||void 0}get theme(){var t,e;const i=this.getAttribute("theme");if("os"===i){return window.matchMedia&&(null===(e=null===(t=window.matchMedia)||void 0===t?void 0:t.call(window,"(prefers-color-scheme: dark)"))||void 0===e?void 0:e.matches)?"dark":"light"}return i||"light"}get telemetryKey(){return this.getAttribute("telemetryKey")||void 0}get autoFocus(){var t;const e=null!==(t=this.getAttribute("auto-focus"))&&void 0!==t?t:"true";return"skipFirstScreen"===e?e:"true"===e}get preferBiometrics(){var t;return"true"===(null!==(t=this.getAttribute("prefer-biometrics"))&&void 0!==t?t:"true")}getExecutionContext(){return t(this,void 0,void 0,(function*(){const{executionContext:t}=yield e(this,ct,"f").call(this);return t}))}getFlowConfig(){var i,o;return t(this,void 0,void 0,(function*(){const{projectConfig:t}=yield e(this,ct,"f").call(this),r=(null===(i=null==t?void 0:t.flows)||void 0===i?void 0:i[this.flowId])||{};return null!==(o=r.version)&&void 0!==o||(r.version=0),r}))}getTargetLocales(){return t(this,void 0,void 0,(function*(){const t=yield this.getFlowConfig();return((null==t?void 0:t.targetLocales)||[]).map((t=>t.toLowerCase()))}))}connectedCallback(){return t(this,void 0,void 0,(function*(){if(this.shadowRoot.isConnected){if(e(this,G,"m",ot).call(this))return void e(this,G,"m",rt).call(this);e(this,G,"m",nt).call(this),e(this,G,"m",ht).call(this),e(this,G,"m",ut).call(this),e(this,G,"m",bt).call(this);const{executionId:t,stepId:o,token:r,code:n,exchangeError:s,redirectAuthCallbackUrl:a,redirectAuthCodeChallenge:l,redirectAuthInitiator:d,oidcIdpStateId:c}=$();window.addEventListener("popstate",e(this,tt,"f").popstate),window.addEventListener("visibilitychange",e(this,tt,"f").visibilitychange),e(this,X,"f").subscribe(e(this,G,"m",dt).bind(this)),e(this,Y,"f").subscribe(e(this,G,"m",gt).bind(this)),e(this,X,"f").update({projectId:this.projectId,flowId:this.flowId,baseUrl:this.baseUrl,tenant:this.tenant,redirectUrl:this.redirectUrl,locale:this.locale,stepId:o,executionId:t,token:r,code:n,exchangeError:s,telemetryKey:this.telemetryKey,redirectAuthCallbackUrl:a,redirectAuthCodeChallenge:l,redirectAuthInitiator:d,oidcIdpStateId:c}),e(this,Y,"f").update({isDebug:this.debug}),i(this,Q,!0,"f")}}))}disconnectedCallback(){e(this,X,"f").unsubscribeAll(),e(this,Y,"f").unsubscribeAll(),e(this,G,"m",pt).call(this),window.removeEventListener("popstate",e(this,tt,"f").popstate)}attributeChangedCallback(t,i,o){if(this.shadowRoot.isConnected&&e(this,Q,"f")&&i!==o&&Tt.observedAttributes.includes(t)){e(this,G,"m",nt).call(this);const r=null===i;e(this,X,"f").update((({stepId:e,executionId:i})=>{let n=e,s=i;return r||(s=null,n=null,L()),{[U(t)]:o,stepId:n,executionId:s}})),e(this,Y,"f").update({isDebug:this.debug})}}}Q=new WeakMap,X=new WeakMap,Y=new WeakMap,Z=new WeakMap,tt=new WeakMap,et=new WeakMap,ct=new WeakMap,G=new WeakSet,it=function(){this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(z.content.cloneNode(!0)),this.rootElement=this.shadowRoot.querySelector("#wc-root")},ot=function(){return!this.shadowRoot.host.closest("form")&&W()},rt=function(){const t=this.shadowRoot.host,e=document.createElement("form");t.parentElement.appendChild(e),e.appendChild(t)},nt=function(){const t=["base-url","tenant","theme","locale","debug","telemetryKey","redirect-url","auto-focus","prefer-biometrics"];if(Tt.observedAttributes.forEach((e=>{if(!t.includes(e)&&!this[U(e)])throw Error(`${e} cannot be empty`)})),this.theme&&"light"!==this.theme&&"dark"!==this.theme)throw Error('Supported theme values are "light", "dark", or leave empty for using the OS theme')},st=function(){const{stepId:t,executionId:i}=O();e(this,X,"f").update({stepId:t,executionId:i})},at=function(){document.hidden||setTimeout((()=>{e(this,X,"f").update({deferredRedirect:!1})}),300)},lt=function(e,i,r){const n=r||void 0,s=!!n;this.sdk=o(Object.assign(Object.assign({persistTokens:!0},Tt.sdkConfigOverrides),{projectId:e,baseUrl:i,fpKey:n,fpLoad:s})),["start","next"].forEach((e=>{const i=this.sdk.flow[e];this.sdk.flow[e]=(...e)=>t(this,void 0,void 0,(function*(){this.nextRequestStatus.update({isLoading:!0});try{return yield i(...e)}finally{this.nextRequestStatus.update({isLoading:!1})}}))}))},dt=function(i,o,r){return t(this,void 0,void 0,(function*(){const{projectId:t,baseUrl:o,telemetryKey:n}=i;if(r("projectId")||r("baseUrl")||r("telemetryKey")){if(!t)return;e(this,G,"m",lt).call(this,t,o,n)}e(this,et,"f").call(this,i)}))},ut=function(){var i,o,r,n;return t(this,void 0,void 0,(function*(){const{projectConfig:t}=yield e(this,ct,"f").call(this);null===(n=null===(r=null===(o=null===(i=null==t?void 0:t.cssTemplate)||void 0===i?void 0:i[this.theme])||void 0===o?void 0:o.typography)||void 0===r?void 0:r.fontFamilies)||void 0===n||n.forEach((t=>(t=>{if(!t)return;const e=document.createElement("link");e.href=t,e.rel="stylesheet",document.head.appendChild(e)})(t.url)))}))},ht=function(){e(this,G,"m",ft).call(this),e(this,G,"m",vt).call(this)},ft=function(){return t(this,void 0,void 0,(function*(){const t=document.createElement("style"),e=E(this.projectId,"theme.css");try{const{body:i}=yield x(e,"text");t.innerText=i}catch(t){this.loggerWrapper.error("Cannot fetch theme file","make sure that your projectId & flowId are correct")}this.shadowRoot.appendChild(t)}))},vt=function(){this.rootElement.setAttribute("data-theme",this.theme)},pt=function(){var t;null===(t=e(this,Z,"f"))||void 0===t||t.remove(),i(this,Z,null,"f")},gt=function({isDebug:o}){return t(this,void 0,void 0,(function*(){o?(yield import("./debugger-wc-b7f03f79.js"),i(this,Z,document.createElement("descope-debugger"),"f"),Object.assign(e(this,Z,"f").style,{position:"fixed",top:"0",right:"0",height:"100vh",width:"100vw",pointerEvents:"none",zIndex:99999}),document.body.appendChild(e(this,Z,"f"))):e(this,G,"m",pt).call(this)}))},mt=function(t,i){var o;t&&this.debug&&(null===(o=e(this,Z,"f"))||void 0===o||o.updateData({title:t,description:i}))},bt=function(){this.rootElement.onkeydown=t=>{if("Enter"!==t.key)return;t.preventDefault();const e=this.rootElement.querySelectorAll("button");if(1===e.length)return void e[0].click();const i=Array.from(e).filter((t=>"button"===t.getAttribute("data-type")));1===i.length&&i[0].click()}},Tt.sdkConfigOverrides={baseHeaders:{"x-descope-sdk-name":"web-component","x-descope-sdk-version":"2.9.0"}};class Mt extends Tt{static set sdkConfigOverrides(t){Tt.sdkConfigOverrides=t}constructor(){const o=new D;super(o.update.bind(o)),wt.add(this),this.stepState=new D({},{updateOnlyOnChange:!1}),yt.set(this,void 0),It.set(this,null),kt.set(this,(()=>{clearInterval(e(this,yt,"f")),i(this,yt,null,"f")})),Ct.set(this,(t=>{var i,o,n,s,a,l,d,c,u;if(!(null==t?void 0:t.ok)){e(this,kt,"f").call(this),e(this,wt,"m",$t).call(this,"error",null==t?void 0:t.error);const r=null===(i=null==t?void 0:t.response)||void 0===i?void 0:i.url,l=`${null===(o=null==t?void 0:t.response)||void 0===o?void 0:o.status} - ${null===(n=null==t?void 0:t.response)||void 0===n?void 0:n.statusText}`;return void this.loggerWrapper.error((null===(s=null==t?void 0:t.error)||void 0===s?void 0:s.errorDescription)||r,(null===(a=null==t?void 0:t.error)||void 0===a?void 0:a.errorMessage)||l)}const f=null===(c=null===(d=null===(l=t.data)||void 0===l?void 0:l.screen)||void 0===d?void 0:d.state)||void 0===c?void 0:c.errorText;(null===(u=t.data)||void 0===u?void 0:u.error)?this.loggerWrapper.error(`[${t.data.error.code}]: ${t.data.error.description}`,`${f?`${f} - `:""}${t.data.error.message}`):f&&this.loggerWrapper.error(f);const{status:v,authInfo:p,lastAuth:m}=t.data;if("completed"===v)return function(t){(null==t?void 0:t.authMethod)&&r&&localStorage.setItem(h,JSON.stringify(t))}(m),e(this,kt,"f").call(this),void e(this,wt,"m",$t).call(this,"success",p);const{executionId:b,stepId:w,stepName:y,action:I,screen:k,redirect:C,webauthn:A,error:S}=t.data;I!==g?(this.loggerWrapper.info(`Step "${y||`#${w}`}" is ${v}`,"",{screen:k,status:v,stepId:w,stepName:y,action:I,error:S}),this.flowState.update({stepId:w,executionId:b,action:I,redirectTo:null==C?void 0:C.url,screenId:null==k?void 0:k.id,screenState:null==k?void 0:k.state,webauthnTransactionId:null==A?void 0:A.transactionId,webauthnOptions:null==A?void 0:A.options})):this.flowState.update({action:I})})),At.set(this,T((()=>t(this,void 0,void 0,(function*(){var t;try{const e=yield this.sdk.webauthn.signIn.start("",window.location.origin);return e.ok||this.loggerWrapper.error("Webauthn start failed",null===(t=null==e?void 0:e.error)||void 0===t?void 0:t.errorMessage),e.data}catch(t){this.loggerWrapper.error("Webauthn start failed",t.message)}}))))),this.flowState=o}connectedCallback(){const e=Object.create(null,{connectedCallback:{get:()=>super.connectedCallback}});var i,o;return t(this,void 0,void 0,(function*(){this.shadowRoot.isConnected&&(null===(i=this.flowState)||void 0===i||i.subscribe(this.onFlowChange.bind(this)),null===(o=this.stepState)||void 0===o||o.subscribe(this.onStepChange.bind(this))),yield e.connectedCallback.call(this)}))}disconnectedCallback(){super.disconnectedCallback(),this.flowState.unsubscribeAll(),this.stepState.unsubscribeAll()}getHtmlFilenameWithLocale(e,i){return t(this,void 0,void 0,(function*(){let t,o=navigator.language;o&&"zh-TW"!==o&&(o=o.split("-")[0]);const r=(e||o||"").toLowerCase();return(yield this.getTargetLocales()).includes(r)&&(t=`${i}-${r}.html`),t}))}getPageContent(e,i){return t(this,void 0,void 0,(function*(){if(i)try{const{body:t}=yield x(i,"text");return t}catch(t){this.loggerWrapper.error(`Failed to fetch html page from ${i}. Fallback to url ${e}`,t)}try{const{body:t}=yield x(e,"text");return t}catch(t){this.loggerWrapper.error(`Failed to fetch html page from ${e}`,t)}return null}))}onFlowChange(o,r,n){var s,a,l,d,c,u;return t(this,void 0,void 0,(function*(){const{projectId:h,flowId:f,tenant:v,stepId:I,executionId:k,action:C,screenId:A,screenState:S,redirectTo:x,redirectUrl:O,token:L,code:U,exchangeError:$,webauthnTransactionId:T,webauthnOptions:M,redirectAuthCodeChallenge:P,redirectAuthCallbackUrl:q,redirectAuthInitiator:N,oidcIdpStateId:F,locale:K}=o;let D,H;e(this,yt,"f")&&e(this,kt,"f").call(this);const V=this.sdk.getLastUserLoginId(),B=yield this.getFlowConfig(),z=q&&P?{callbackUrl:q,codeChallenge:P}:void 0;if(!k&&(B.conditions?({startScreenId:D,conditionInteractionId:H}=((t,e)=>{const i=null==e?void 0:e.find((({key:e,operator:i})=>{var o;if("ELSE"===e)return!0;const r=null===(o=J[e])||void 0===o?void 0:o[i];return!!(null==r?void 0:r(t))}));return i?{startScreenId:i.met.screenId,conditionInteractionId:i.met.interactionId}:{}})({loginId:V,code:U,token:L},B.conditions)):B.condition?({startScreenId:D,conditionInteractionId:H}=((t,e)=>{var i;const o=null===(i=J[null==t?void 0:t.key])||void 0===i?void 0:i[t.operator];if(!o)return{};const r=o(e)?t.met:t.unmet;return{startScreenId:null==r?void 0:r.screenId,conditionInteractionId:null==r?void 0:r.interactionId}})(B.condition,{loginId:V,code:U,token:L})):D=B.startScreenId,!R(D,F))){const t={};let i=!1;U&&(i=!0,t.exchangeCode=U,t.idpInitiated=!0),L&&(i=!0,t.token=L);const o=yield this.sdk.flow.start(f,Object.assign(Object.assign({tenant:v,redirectAuth:z,oidcIdpStateId:F},O&&{redirectUrl:O}),{lastAuth:_(V)}),H,"",i?t:void 0,B.version);return e(this,Ct,"f").call(this,o),void("completed"!==(null===(s=null==o?void 0:o.data)||void 0===s?void 0:s.status)&&this.flowState.update({code:void 0,token:void 0}))}if(k&&(n("token")&&L||n("code")&&U||n("exchangeError")&&$)){const t=yield this.sdk.flow.next(k,I,w,{token:L,exchangeCode:U,exchangeError:$},B.version);return e(this,Ct,"f").call(this,t),void this.flowState.update({token:void 0,code:void 0,exchangeError:void 0})}if(C===p&&(n("redirectTo")||n("deferredRedirect")))return x?"android"===N&&document.hidden?void this.flowState.update({deferredRedirect:!0}):void window.location.assign(x):void this.loggerWrapper.error("Did not get redirect url");if(C===m||C===b){if(!T||!M)return void this.loggerWrapper.error("Did not get webauthn transaction id or options");let t,o,r=M;if(this.preferBiometrics&&C===m&&W()&&(yield null===(l=null===(a=window.PublicKeyCredential)||void 0===a?void 0:a.isUserVerifyingPlatformAuthenticatorAvailable)||void 0===l?void 0:l.call(a)))try{const t=JSON.parse(r);t.publicKey&&((c=t.publicKey).authenticatorSelection||(c.authenticatorSelection={}),(u=t.publicKey.authenticatorSelection).authenticatorAttachment||(u.authenticatorAttachment="platform"),r=JSON.stringify(t))}catch(t){this.loggerWrapper.info("Failed to modify webauthn create options")}null===(d=e(this,It,"f"))||void 0===d||d.abort(),i(this,It,null,"f");try{t=C===m?yield this.sdk.webauthn.helpers.create(r):yield this.sdk.webauthn.helpers.get(r)}catch(t){if("NotAllowedError"!==t.name)return void this.loggerWrapper.error(t.message);o=!0}const n=yield this.sdk.flow.next(k,I,w,{transactionId:T,response:t,cancelWebauthn:o},B.version);e(this,Ct,"f").call(this,n)}if(C===g&&i(this,yt,setInterval((()=>t(this,void 0,void 0,(function*(){const t=yield this.sdk.flow.next(k,I,y,{},B.version);e(this,Ct,"f").call(this,t)}))),2e3),"f"),!A&&!D)return void this.loggerWrapper.warn("No screen was found to show");const G=D||A,Q=yield this.getHtmlFilenameWithLocale(K,G),X={direction:j(+I,+r.stepId),screenState:Object.assign(Object.assign({},S),{lastAuth:{loginId:V,name:this.sdk.getLastUserDisplayName()||V}}),htmlUrl:E(h,`${G}.html`),htmlLocaleUrl:Q&&E(h,Q)},Y=_(V);R(D,F)?X.next=(t,e)=>this.sdk.flow.start(f,Object.assign({tenant:v,redirectAuth:z,oidcIdpStateId:F,lastAuth:Y},O&&{redirectUrl:O}),H,t,Object.assign(Object.assign(Object.assign({},e),U&&{exchangeCode:U,idpInitiated:!0}),L&&{token:L}),B.version):(n("projectId")||n("baseUrl")||n("executionId")||n("stepId"))&&(X.next=(...t)=>this.sdk.flow.next(k,I,...t)),this.stepState.update(X)}))}onStepChange(i,o){var r;return t(this,void 0,void 0,(function*(){const{htmlUrl:n,htmlLocaleUrl:s,direction:a,next:l,screenState:d}=i,c=document.createElement("template");c.innerHTML=yield this.getPageContent(n,s);const u=c.content.cloneNode(!0),h=((t,e)=>{var i;const o=Array.from(t.querySelectorAll("script[data-id]")).map((i=>{var o;const r=i.getAttribute("data-id"),n=null===(o=t.getElementById(r))||void 0===o?void 0:o.innerHTML,s=Function(n).bind(i.previousSibling,e);return i.remove(),s}));return null===(i=t.querySelector("scripts"))||void 0===i||i.remove(),o})(u,yield this.getExecutionContext());this.sdk.webauthn.helpers.isSupported()?yield e(this,wt,"m",xt).call(this,u,l):u.querySelectorAll(`button[${v}="biometrics"]`).forEach((t=>t.setAttribute("disabled","true"))),V(u,d,this.errorTransformer,this.loggerWrapper),((t,e)=>{var i;e&&(null===(i=null==t?void 0:t.style)||void 0===i||i.setProperty("--totp-image",`url(data:image/jpg;base64,${e})`))})(u.querySelector("div"),null===(r=null==d?void 0:d.totp)||void 0===r?void 0:r.image);const f=()=>t(this,void 0,void 0,(function*(){try{h.forEach((t=>{t()}))}catch(t){this.loggerWrapper.error(t.message)}this.rootElement.replaceChildren(u);const t=!o.htmlUrl;((t,e,i)=>{if(!0===e||"skipFirstScreen"===e&&!i){const e=t.querySelector('input:not([aria-hidden="true"])');null==e||e.focus()}})(this.rootElement,this.autoFocus,t),e(this,wt,"m",Lt).call(this,l),e(this,wt,"m",$t).call(this,"page-updated",{});if(this.rootElement.querySelector(`[${v}="polling"]`)){const t=yield l(y,{});e(this,Ct,"f").call(this,t)}}));a?e(this,wt,"m",Ut).call(this,f,a):f()}))}}yt=new WeakMap,It=new WeakMap,kt=new WeakMap,Ct=new WeakMap,At=new WeakMap,wt=new WeakSet,St=function(t){const e=t.name;if(!["email"].includes(e)){const i=`user-${e}`;t.name=i,t.addEventListener("input",(()=>{t.name=t.value?e:i}))}},xt=function(o,r){var n;return t(this,void 0,void 0,(function*(){null===(n=e(this,It,"f"))||void 0===n||n.abort();const s=o.querySelector('input[autocomplete="webauthn"]');if(s&&(yield B())){const{options:o,transactionId:n}=(yield e(this,At,"f").call(this))||{};o&&n&&(e(this,wt,"m",St).call(this,s),i(this,It,new AbortController,"f"),this.sdk.webauthn.helpers.conditional(o,e(this,It,"f")).then((i=>t(this,void 0,void 0,(function*(){const t=yield r(s.id,{transactionId:n,response:i});e(this,Ct,"f").call(this,t)})))).catch((t=>{"AbortError"!==t.name&&this.loggerWrapper.error("Conditional login failed",t.message)})))}}))},Et=function(){return Array.from(this.shadowRoot.querySelectorAll(".descope-input")).every((t=>(t.reportValidity(),t.checkValidity())))},jt=function(){return t(this,void 0,void 0,(function*(){const e=Array.from(this.shadowRoot.querySelectorAll(`.descope-input[name]:not([${u}])`)),i=yield Promise.all(e.map((e=>t(this,void 0,void 0,(function*(){const t=yield(t=>new Promise((e=>{var i;switch(t.type){case"checkbox":e(t.checked);break;case"file":{const o=new FileReader;(null===(i=t.files)||void 0===i?void 0:i.length)?(o.onload=t=>{const i=t.target.result;e(i)},o.readAsDataURL(t.files[0])):e(null);break}default:e(t.value)}})))(e);return{name:e.name,value:t}})))));return i.reduce(((t,e)=>Object.assign(Object.assign({},t),{[e.name]:e.value})),{})}))},Ot=function(t){const e=this.nextRequestStatus.subscribe((({isLoading:i})=>{var o,r;i?null===(o=null==t?void 0:t.classList)||void 0===o||o.add("loading"):(this.nextRequestStatus.unsubscribe(e),null===(r=null==t?void 0:t.classList)||void 0===r||r.remove("loading"))}))},Wt=function(i,o){return t(this,void 0,void 0,(function*(){if(i.formNoValidate||e(this,wt,"m",Et).call(this)){const r=null==i?void 0:i.getAttribute("id");e(this,wt,"m",Ot).call(this,i);const n=yield e(this,wt,"m",jt).call(this),s=(t=i,Array.from((null==t?void 0:t.attributes)||[]).reduce(((t,e)=>{var i;const o=null===(i=new RegExp("^data-descope-(\\S+)$").exec(e.name))||void 0===i?void 0:i[1];return o?Object.assign(t,{[o]:e.value}):t}),{})),a=Object.assign(Object.assign(Object.assign({},s),n),{origin:window.location.origin}),l=yield o(r,a);e(this,Ct,"f").call(this,l)}var t}))},Lt=function(t){this.rootElement.querySelectorAll("button:not([data-exclude-next])").forEach((i=>{i.onclick=()=>{e(this,wt,"m",Wt).call(this,i,t)}}))},Ut=function(t,e){this.rootElement.addEventListener("transitionend",(()=>{this.rootElement.classList.remove("fade-out"),t()}),{once:!0});const i=e===I.forward?"slide-forward":"slide-backward";Array.from(this.rootElement.getElementsByClassName("input-container")).forEach(((t,e)=>{t.style["transition-delay"]=40*e+"ms",t.classList.add(i)})),this.rootElement.classList.add("fade-out")},$t=function(t,e){this.dispatchEvent(new CustomEvent(t,{detail:e}))},customElements.define("descope-wc",Mt);export{Mt as D,D as S};
